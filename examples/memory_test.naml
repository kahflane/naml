///
/// Memory Management Test
///
/// Tests reference counting and cleanup for heap-allocated types.
/// Run this multiple times and monitor memory usage to verify no leaks.
///

use std::collections::arrays::count;
use std::testing::*;

fn test_string_cleanup() {
    println("=== String Cleanup Test ===");
    var s: string = "hello world";
    println(s);
    assert_eq_string(s, "hello world", "Initial string should be 'hello world'");
    var s2: string = "goodbye world";
    s = s2;
    println(s);
    assert_eq_string(s, "goodbye world", "String after reassignment should be 'goodbye world'");
}

fn test_string_reassignment() {
    println("=== String Reassignment Test ===");
    var name: string = "Alice";
    println(name);
    assert_eq_string(name, "Alice", "Name should be 'Alice' initially");
    name = "Bob";
    println(name);
    assert_eq_string(name, "Bob", "Name should be 'Bob' after first reassignment");
    name = "Charlie";
    println(name);
    assert_eq_string(name, "Charlie", "Name should be 'Charlie' after second reassignment");
}

fn test_array_cleanup() {
    println("=== Array Cleanup Test ===");
    var arr: [int] = [1, 2, 3, 4, 5];
    print("Array length: ");
    println(count(arr));
    assert_eq(count(arr), 5, "Array should have 5 elements");
}

fn test_map_cleanup() {
    println("=== Map Cleanup Test ===");
    var scores: map<string, int> = {};
    scores["alice"] = 100;
    scores["bob"] = 95;
    print("Alice score: ");
    println(scores["alice"]);
    print("Bob score: ");
    println(scores["bob"]);
}

fn test_loop_allocations() {
    println("=== Loop Allocation Test ===");
    var loop_count: int = 0;
    while (loop_count < 5) {
        var temp: string = "iteration";
        print(temp);
        print(": ");
        println(loop_count);
        loop_count = loop_count + 1;
    }
    println("Loop completed");
}

struct TestStruct {
    value: int,
    name: string
}

fn test_struct_cleanup() {
    println("=== Struct Cleanup Test ===");
    var ts: TestStruct = TestStruct { value: 42, name: "test struct" };
    print("Struct value: ");
    println(ts.value);
    assert_eq(ts.value, 42, "Struct value should be 42");
    print("Struct name: ");
    println(ts.name);
    assert_eq_string(ts.name, "test struct", "Struct name should be 'test struct'");
}

fn main() {
    println("========================================");
    println("       Memory Management Tests         ");
    println("========================================");
    println("");

    test_string_cleanup();
    println("");

    test_string_reassignment();
    println("");

    test_array_cleanup();
    println("");

    test_map_cleanup();
    println("");

    test_loop_allocations();
    println("");

    test_struct_cleanup();
    println("");

    println("========================================");
    println("         All Tests Completed!          ");
    println("========================================");
}
