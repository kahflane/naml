///
/// Struct Cleanup Test
///
/// Tests that structs with heap-allocated fields are properly cleaned up.
/// Each struct should have its heap fields decremented when the struct is freed.
///

use std::collections::arrays::count;
use std::testing::*;

struct Person {
    name: string,
    age: int
}

struct PersonWithScores {
    name: string,
    scores: [int],
    metadata: map<string, int>
}

struct SimpleStruct {
    value: int,
    count_val: int
}

fn test_simple_struct() {
    println("=== Simple Struct Test (no heap fields) ===");
    var s: SimpleStruct = SimpleStruct { value: 42, count_val: 10 };
    print("Value: ");
    println(s.value);
    assert_eq(s.value, 42, "Simple struct value should be 42");
    print("Count: ");
    println(s.count_val);
    assert_eq(s.count_val, 10, "Simple struct count_val should be 10");
}

fn test_struct_with_string() {
    println("=== Struct With String Test ===");
    var p: Person = Person { name: "Alice", age: 30 };
    print("Name: ");
    println(p.name);
    assert_eq_string(p.name, "Alice", "Person name should be Alice");
    print("Age: ");
    println(p.age);
    assert_eq(p.age, 30, "Person age should be 30");
}

fn test_struct_with_array() {
    println("=== Struct With Array Test ===");
    var ps: PersonWithScores = PersonWithScores {
        name: "Bob",
        scores: [95, 88, 92],
        metadata: {}
    };
    ps.metadata["grade"] = 100;
    print("Name: ");
    println(ps.name);
    assert_eq_string(ps.name, "Bob", "PersonWithScores name should be Bob");
    print("Scores length: ");
    println(count(ps.scores));
    assert_eq(count(ps.scores), 3, "PersonWithScores should have 3 scores");
}

fn test_struct_reassignment() {
    println("=== Struct Reassignment Test ===");
    var p: Person = Person { name: "First", age: 20 };
    println(p.name);
    assert_eq_string(p.name, "First", "First reassignment should be 'First'");
    p = Person { name: "Second", age: 25 };
    println(p.name);
    assert_eq_string(p.name, "Second", "Second reassignment should be 'Second'");
    p = Person { name: "Third", age: 30 };
    println(p.name);
    assert_eq_string(p.name, "Third", "Third reassignment should be 'Third'");
}

fn test_loop_struct_creation() {
    println("=== Loop Struct Creation Test ===");
    var loop_count: int = 0;
    while (loop_count < 3) {
        var p: Person = Person { name: "Temp", age: loop_count };
        print("Loop iteration: ");
        println(loop_count);
        loop_count = loop_count + 1;
    }
    println("Loop completed");
}

fn main() {
    println("========================================");
    println("       Struct Cleanup Tests           ");
    println("========================================");
    println("");

    test_simple_struct();
    println("");

    test_struct_with_string();
    println("");

    test_struct_with_array();
    println("");

    test_struct_reassignment();
    println("");

    test_loop_struct_creation();
    println("");

    println("========================================");
    println("         All Tests Completed!          ");
    println("========================================");
}
